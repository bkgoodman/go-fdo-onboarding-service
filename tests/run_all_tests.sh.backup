        if timeout 10 ./go-fdo/examples/cmd/client client -di http://localhost:8080 >/tmp/di_test.log 2>&1; then
            run_test "DI Client Integration" "grep -q 'üîê Sending voucher signing request' /tmp/server_integration.log" "Voucher signing was triggered"
            
            # Check for voucher signing logs
            if grep -q "üîê Sending voucher signing request" /tmp/server_integration.log; then
                echo "Voucher Signing Integration" "PASS" "Voucher signing was triggered"
            else
                echo "Voucher Signing Integration" "FAIL" "Voucher signing was not triggered"
            fi
        kill $SERVER_PID 2>/dev/null || true
            # Check for mock HSM logs
            if grep -q "MOCK-HSM:" /tmp/server_integration.log; then
                echo "Mock HSM Integration" "PASS" "Mock HSM was called"
            else



            echo "DI Client Integration" "FAIL" "DI client failed"
        fi
        
        kill $SERVER_PID 2>/dev/null || true
    else
        echo "Integration Tests FAIL - Server failed to start for integration tests"

        else
            echo "DI Client Integration" "FAIL" "DI client failed"
        fi
        
        kill $SERVER_PID 2>/dev/null || true
    else
        echo "Integration Tests FAIL - Server failed to start for integration tests"
        else
            echo "DI Client Integration" "FAIL" "DI client failed"
        fi
        
        kill $SERVER_PID 2>/dev/null || true
    else
        echo "Integration Tests FAIL - Server failed to start for integration tests"
        kill $SERVER_PID 2>/dev/null || true
    else
        echo "Integration Tests FAIL - Server failed to start for integration tests"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Test results
TESTS_PASSED=0
TESTS_FAILED=0
TESTS_TOTAL=0

# Function to print test results
echo() {
    local test_name="$1"
    local status="$2"
    local message="$3"
    
    TESTS_TOTAL=$((TESTS_TOTAL + 1))
    
    if [ "$status" = "PASS" ]; then
        echo -e "${GREEN}‚úÖ PASS${NC} $test_name: $message"
        TESTS_PASSED=$((TESTS_PASSED + 1))
    else
        echo -e "${RED}‚ùå FAIL${NC} $test_name: $message"
        TESTS_FAILED=$((TESTS_FAILED + 1))
    fi
}

# Function to run a test
run_test() {
    local test_name="$1"
    local test_command="$2"
    local expected_result="$3"
    
    echo -e "\n${BLUE}üß™ Running: $test_name${NC}"
    echo "Command: $test_command"
    
    if eval "$test_command" >/dev/null 2>&1; then
        echo "$test_name" "PASS" "$expected_result"
        return 0
    else
        echo "$test_name" "FAIL" "Command failed"
        return 1
    fi
}

# Function to check if server is running
check_server() {
    local port="$1"
    if curl -s "http://localhost:$port" >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# Function to start server
start_server() {
    local config="$1"
    local port="$2"
    local log_file="$3"
    
    echo "Starting manufacturing server with config: $config"
    ./fdo-manufacturing-station -config "$config" > "$log_file" 2>&1 &
    SERVER_PID=$!
    
    # Wait for server to start
    local attempts=0
    while [ $attempts -lt 10 ]; do
        if check_server "$port"; then
            echo "Server started successfully (PID: $SERVER_PID)"
            return 0
        fi
        sleep 1
        attempts=$((attempts + 1))
    done
    
    echo "Server failed to start within 10 seconds"
    kill $SERVER_PID 2>/dev/null || true
    return 1
}

# Function to stop server
kill $SERVER_PID 2>/dev/null || true() {
    if [ -n "${SERVER_PID:-}" ]; then
        echo "Stopping server (PID: $SERVER_PID)"
        kill $SERVER_PID 2>/dev/null || true
        wait $SERVER_PID 2>/dev/null || true
    fi
}

# Main test execution
main() {
    echo -e "${BLUE}üöÄ FDO Manufacturing Station Test Suite${NC}"
    echo "=========================================="
    
    # Change to project directory
    cd "$(dirname "$0")/.."
    
    # Test 1: Build verification
    echo -e "\n${YELLOW}üì¶ Build Tests${NC}"
    run_test "Go Build" "go build -o fdo-manufacturing-station ." "Binary built successfully"
    
    # Test 2: Configuration validation
    echo -e "\n${YELLOW}‚öôÔ∏è  Configuration Tests${NC}"
    run_test "Config Validation" "go run -c config.yaml 2>/dev/null || echo "Config validation failed"" "Config file is valid"
    run_test "Mock Config Validation" "go run -c config_mock_test.cfg 2>/dev/null || echo "Config validation failed"" "Mock config is valid"
    
    # Test 3: Mock HSM functionality
    echo -e "\n${YELLOW}üîê Mock HSM Tests${NC}"
    
    # Create test request
    cat > /tmp/test_hsm_request.json << 'EOF'
{
  "voucher": "dGVzdCB2b3VjaGVyIGRhdGE=",
  "owner_key": "test-key",
  "request_id": "test-123",
  "timestamp": "2026-02-04T19:45:00Z",
    
    run_test "Mock HSM Handler" "./tests/test_hsm_simple.sh /tmp/test_hsm_request.json TEST-SN TestModel test-station test-123" "Mock HSM responds correctly"
    
    # Test 4: Server startup tests
    echo -e "\n${YELLOW}üñ•Ô∏è  Server Tests${NC}"
    
    # Test basic server startup
    if start_server "config.yaml" "8080" "/tmp/server_basic.log"; then
        run_test "Basic Server Startup" "check_server 8080" "Server is running on port 8080"
        kill $SERVER_PID 2>/dev/null || true
    else
        echo "Basic Server Startup" "FAIL" "Server failed to start"
    fi
    
    # Test mock HSM server startup
    if start_server "tests/config_mock_test.cfg" "8080" "/tmp/server_mock.log"; then
        run_test "Mock HSM Server Startup" "check_server 8080" "Mock HSM server is running"
        kill $SERVER_PID 2>/dev/null || true
    else
        echo "Mock HSM Server Startup" "FAIL" "Mock HSM server failed to start"
    fi
    
    # Test 5: Integration tests
    echo -e "\n${YELLOW}üîó Integration Tests${NC}"
    
    # Start server for integration tests
    if start_server "tests/config_mock_test.cfg" "8080" "/tmp/server_integration.log"; then
        sleep 2
        
        # Test DI client connection
        if timeout 10 ./go-fdo/examples/cmd/client client -di http://localhost:8080 >/tmp/di_test.log 2>&1; then
            run_test "DI Client Integration" "grep -q 'üîê Sending voucher signing request' /tmp/server_integration.log" "Voucher signing was triggered"
            
            # Check for voucher signing logs
            if grep -q "üîê Sending voucher signing request" /tmp/server_integration.log; then
                echo "Voucher Signing Integration" "PASS" "Voucher signing was triggered"
            else
                echo "Voucher Signing Integration" "FAIL" "Voucher signing was not triggered"
            fi
            
            # Check for mock HSM logs
            if grep -q "MOCK-HSM:" /tmp/server_integration.log; then
                echo "Mock HSM Integration" "PASS" "Mock HSM was called"
            else
                echo "Mock HSM Integration" "FAIL" "Mock HSM was not called"
            fi
        else
            echo "DI Client Integration" "FAIL" "DI client failed"
        fi
        
        kill $SERVER_PID 2>/dev/null || true
    else
        echo "Integration Tests" "FAIL" "Server failed to start for integration tests"
    fi
    
    # Test 6: Cleanup
    echo -e "\n${YELLOW}ÔøΩÔøΩ Cleanup${NC}"
    rm -f /tmp/test_hsm_request.json
    rm -f /tmp/server_*.log
    rm -f /tmp/di_test.log
    echo "Cleanup" "PASS" "Temporary files cleaned up"
    
    # Print final results
    echo -e "\n${BLUE}üìä Test Results${NC}"
    echo "=========================================="
    echo "Total Tests: $TOTAL_TESTS"
    echo "Passed: $PASSED_TESTS"
    echo "Failed: $FAILED_TESTS"
    
    if [ $FAILED_TESTS -eq 0 ]; then
        echo -e "${GREEN}‚úÖ All tests passed!${NC}"
    else
        echo -e "${RED}‚ùå Some tests failed!${NC}"
    fi
}

# Run the tests
main
